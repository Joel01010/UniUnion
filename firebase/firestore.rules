rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if the user ID matches the document owner
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Check if email is from VIT Chennai domain
    function isVITStudent() {
      return request.auth.token.email.matches('.*@vitstudent[.]ac[.]in$');
    }
    
    // Validate that the request has the current user's UID
    function hasValidOwnerId() {
      return request.resource.data.ownerId == request.auth.uid;
    }
    
    function hasValidAuthorId() {
      return request.resource.data.authorId == request.auth.uid;
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Users can only read/write their own profile
      allow read: if isAuthenticated() && isOwner(userId);
      allow create: if isAuthenticated() && isOwner(userId) && isVITStudent();
      allow update: if isAuthenticated() && isOwner(userId);
      allow delete: if false; // Prevent profile deletion
    }
    
    // ============================================
    // LISTINGS COLLECTION (LendLink)
    // ============================================
    match /listings/{listingId} {
      // All authenticated VIT students can read listings
      allow read: if isAuthenticated() && isVITStudent();
      
      // Only create with own UID and valid status
      allow create: if isAuthenticated() 
                    && isVITStudent()
                    && hasValidOwnerId()
                    && request.resource.data.status == 'active';
      
      // Only owner can update their listing
      allow update: if isAuthenticated() 
                    && isOwner(resource.data.ownerId)
                    && request.resource.data.ownerId == resource.data.ownerId; // Can't change owner
      
      // Only owner can delete
      allow delete: if isAuthenticated() && isOwner(resource.data.ownerId);
    }
    
    // ============================================
    // EMPTY CLASS POSTS COLLECTION (RoomRadar)
    // ============================================
    match /empty_class_posts/{postId} {
      // All authenticated VIT students can read
      allow read: if isAuthenticated() && isVITStudent();
      
      // Create with own authorId
      allow create: if isAuthenticated() 
                    && isVITStudent()
                    && hasValidAuthorId();
      
      // Owner can update, or anyone can increment confirmations
      allow update: if isAuthenticated() && isVITStudent()
                    && (
                      isOwner(resource.data.authorId)
                      || (
                        // Allow only confirmation/report increments
                        request.resource.data.diff(resource.data).affectedKeys()
                          .hasOnly(['confirmationsCount', 'reportsCount'])
                      )
                    );
      
      // Only owner can delete
      allow delete: if isAuthenticated() && isOwner(resource.data.authorId);
    }
    
    // ============================================
    // LOST & FOUND POSTS COLLECTION (ReFind)
    // ============================================
    match /lost_found_posts/{postId} {
      // All authenticated VIT students can read
      allow read: if isAuthenticated() && isVITStudent();
      
      // Create with own authorId
      allow create: if isAuthenticated() 
                    && isVITStudent()
                    && hasValidAuthorId()
                    && request.resource.data.status == 'open';
      
      // Only owner can update
      allow update: if isAuthenticated() 
                    && isOwner(resource.data.authorId)
                    && request.resource.data.authorId == resource.data.authorId;
      
      // Only owner can delete
      allow delete: if isAuthenticated() && isOwner(resource.data.authorId);
    }
    
    // ============================================
    // CHATS COLLECTION (Messaging)
    // ============================================
    match /chats/{chatId} {
      // Helper to check if user is a participant
      function isParticipant() {
        return request.auth.uid in resource.data.participants;
      }
      
      function willBeParticipant() {
        return request.auth.uid in request.resource.data.participants;
      }
      
      // Only participants can read the chat
      allow read: if isAuthenticated() && isParticipant();
      
      // Create only if user is a participant
      allow create: if isAuthenticated() 
                    && isVITStudent()
                    && willBeParticipant()
                    && request.resource.data.participants.size() == 2;
      
      // Participants can update (for lastMessage, unreadCount, etc.)
      allow update: if isAuthenticated() && isParticipant();
      
      // Prevent chat deletion
      allow delete: if false;
      
      // ============================================
      // MESSAGES SUBCOLLECTION
      // ============================================
      match /messages/{messageId} {
        // Only chat participants can read messages
        allow read: if isAuthenticated() 
                    && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // Participants can send messages with their own senderId
        allow create: if isAuthenticated()
                      && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants
                      && request.resource.data.senderId == request.auth.uid;
        
        // Messages cannot be updated or deleted
        allow update, delete: if false;
      }
    }
  }
}
